<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BIM for On-Chip OAD (Split Image) &mdash; 
SimpleLink™ CC2640R2 SDK
User&#39;s Guide for BLE-Stack 3.x.x
 3.03.09.00 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OAD Image Header" href="image-header.html" />
    <link rel="prev" title="BIM for Off-Chip OAD" href="bim-off-chip.html" />
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug oad-secure bim-on-chip-split-image";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>


</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../ble-stack-3.x-guide/index.html" class="icon icon-home"> 
SimpleLink™ CC2640R2 SDK
User's Guide for BLE-Stack 3.x.x

          </a>
              <div class="version">
                3.03.09.00
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/platform.html">The CC2640R2 SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/tirtos-index.html">TI-RTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/ble-stack-3-index.html">Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/ble-stack-3-index.html#ble-stack">BLE-Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/ble-stack-3-index.html#developing-a-custom-application">Developing a Custom Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/ble-stack-3-index.html#ble-network-processor">BLE Network Processor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/ble-stack-3-index.html#running-the-sdk-on-custom-hardware">Running the SDK on Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/u-stack-index.html">Micro BLE Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-common/npi-index.html">Network Processor Interface (NPI)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../ble-stack-3.x-guide/index-oad-cc2640.html">Over-the-Air Download (OAD)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="oad-types-cc2640.html">OAD Storage &amp; Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="bim.html">Boot Image Manager (BIM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="bim-off-chip.html">BIM for Off-Chip OAD</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">BIM for On-Chip OAD (Split Image)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#application-execution-switching-using-ram">Application Execution switching using RAM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="image-header.html">OAD Image Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="ext-flash-image-header.html">OAD External Flash Image Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="flash-layout-off-chip.html">Flash Layout for Off-Chip OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="flash-layout-on-chip-split-image.html">Flash Layout for On-Chip OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools.html">OAD Image Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble3-stack-oad/oad-application.html">OAD Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble3-stack-oad/oad-profile.html">BLE-Stack OAD Profile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble3-stack-oad/setting-up-environment.html">Setting up the BLE OAD Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble3-stack-oad/performing-an-oad.html">Performing a BLE OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble3-stack-oad/creating-a-production-image.html">Creating a Production Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ble3-stack-oad/add-ble-oad-to-proj.html">Adding BLE OAD to an Existing Project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../voice/voice.html">Creating a Voice Enabled Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/secure-fw-index.html">Secure Firmware (SFW)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/debugging-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/migration.html">Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/api-reference.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/reference.html">Terms and Definitions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-3.x-guide/index.html">
SimpleLink™ CC2640R2 SDK
User's Guide for BLE-Stack 3.x.x
</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../ble-stack-3.x-guide/index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../ble-stack-3.x-guide/index-oad-cc2640.html">Over-the-Air Download (OAD)</a> &raquo;</li>
      <li>BIM for On-Chip OAD (Split Image)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="bim-for-on-chip-oad-split-image">
<span id="sec-oad-bim-on-chip"></span><h1>BIM for On-Chip OAD (Split Image)<a class="headerlink" href="#bim-for-on-chip-oad-split-image" title="Permalink to this headline">¶</a></h1>
<p>This section describes the behavior of the BIM for on-chip OAD where
the split image approach is used. This approach requires the application and
protocol stack to be separately executable images. As with off-chip OAD, it is
BIM’s responsibility to locate which image should be run. In an on-chip OAD
system there are only two image types that can be executed safely:</p>
<blockquote>
<div><ul class="simple">
<li><p>Persistent application (0x00): Permanently resident application that
implements OAD profile</p></li>
<li><p>User application (0x01): OAD upgradeable application that implements OAD
reset service and user functionality</p></li>
</ul>
</div></blockquote>
<p>For more information about OAD image types, refer to the
<a class="reference internal" href="image-header.html#sec-oad-image-header"><span class="std std-ref">OAD Image Header</span></a> section of this chapter. The roles and
responsibilities of each application in an on-chip system is defined in the
<a class="reference internal" href="../ble3-stack-oad/oad-application.html#oad-process"><span class="std std-ref">OAD Application</span></a> section.</p>
<p>In summary, the applications are responsible for storing a candidate image in
internal flash, performing all OAD procedures and protocols, setting the BIM
variable, and resetting the device when appropriate. The BIM variable is a
shared RAM variable that allows the application to indicate which image should
be selected by the BIM before resetting. This is described in
<a class="reference internal" href="#sect-ram-argument"><span class="std std-ref">Application Execution switching using RAM</span></a>.</p>
<p>Based on the BIM var and the fields in the image header, the BIM will decide
which image is most fit to run. The following will
describe the process by which the BIM selects an image.</p>
<div class="figure align-center" id="id3">
<span id="fig-bim-on-chip-split-image-flowchart"></span><a class="reference internal image-reference" href="../_images/bim_sequence_diagram_onchip_splitimage.png"><img alt="../_images/bim_sequence_diagram_onchip_splitimage.png" src="../_images/bim_sequence_diagram_onchip_splitimage.png" style="width: 867.0px; height: 900.0px;" /></a>
<p class="caption"><span class="caption-number">Figure 94. </span><span class="caption-text">Functional Overview of On-chip BIM (split image)</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>The image above is described in words below. In order to determine which
image is best to run, BIM takes the following measures:</p>
<blockquote>
<div><ol class="arabic">
<li><dl class="simple">
<dt>At startup, the BIM checks the BIM variable and sets active flash page or</dt><dd><p>image type based on <a class="reference internal" href="#sect-ram-argument"><span class="std std-ref">Application Execution switching using RAM</span></a>. If BIM variable is unset
it will default to flash page of 0 and image type of user application.</p>
</dd>
</dl>
</li>
<li><p>BIM checks to make sure the max search iterations have not been exceeded</p></li>
<li><p>BIM looks for a valid image header in internal flash by reading the first
8 bytes to find the valid image Identification value.</p>
<blockquote>
<div><ul class="simple">
<li><p>If a valid image header is found, BIM will read the entire image
header</p></li>
<li><p>If a header is not found, increment the flash page and search again
(jump to step #2)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Checks that the header and BIM version are compatible with the current
BIM</p>
<blockquote>
<div><ul class="simple">
<li><p>Also checks that the if the image needs copy, it must be a stack image.</p></li>
<li><p>If this check fails, increase the flash page number and search again
(jump to step #2). If user application, change image type to
persistent application before searching again</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If a CRC has not been calculated on the image, calculate one and update
CRC status field.</p>
<blockquote>
<div><ul class="simple">
<li><p>If pending copy (stack image), do not update the CRC field yet, this
will be done after copy</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check for security. (if not persistent application)</p>
<blockquote>
<div><ul class="simple">
<li><p>Ensure image is from a trusted peer by running ECDSA sign/verify
algorithm on the image.</p></li>
<li><p>If security check fails, increment the flash page and search again
(jump to step #2)</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check if the image needs to be copied (stack image)</p>
<blockquote>
<div><ul class="simple">
<li><p>Copy image, calculate CRC to ensure copy succeeded. Update copy status
and CRC status fields accordingly.</p></li>
<li><p>If succeeded, set image type to persistent application and set flash
page number to 0.</p></li>
<li><p>If failed, continue searching.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Continue this process until an image is found or the max iterations is
performed.</p>
<blockquote>
<div><ul class="simple">
<li><p>If a valid image is found, jump to it</p></li>
<li><p>If no valid image is found and the max iterations have been performed,
go to low power mode.</p></li>
</ul>
</div></blockquote>
</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The execution flow described by the text and diagrams above is assuming
security is on. If using an unsecured BIM configuration, the process is the
same with the exception that there is no check for security.</p>
</div>
<div class="section" id="application-execution-switching-using-ram">
<span id="sect-ram-argument"></span><h2>Application Execution switching using RAM<a class="headerlink" href="#application-execution-switching-using-ram" title="Permalink to this headline">¶</a></h2>
<p>On devices which have RAM retention capability between resets, execution
switching between application can be done using RAM variables.
For example, on the CC2640R2, execution switching between User and Persistent
Applications will be done by writing to a RAM variable stored at
a known RAM location. This location will be used explicitly for application
switching only. The value will be retained between resets.</p>
<p>The RAM variable called ‘BIM Argument’ is two bytes long with values as defined
in <a class="reference internal" href="#tbl-bim-argument"><span class="std std-ref">Description of the BIM Argument variable.</span></a>. The byte 0 value defines the meaning of
the byte 1 content. In <a class="reference external" href="http://www.ti.com/tool/SIMPLELINK-CC2640R2-SDK">SimpleLink CC2640R2 SDK</a>, there are two valid values for byte 0: ‘0’ and ‘1’.
Values 2-255 are reserved for future use. If BIM encounters a byte0 value
greater than 1, it will consider if invalid, will try to find the
default application starting from flash page ‘0’, by reading image header.</p>
<span id="tbl-bim-argument"></span><table class="docutils align-default" id="id4">
<caption><span class="caption-number">Table 22. </span><span class="caption-text">Description of the BIM Argument variable.</span><a class="headerlink" href="#id4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 16%" />
<col style="width: 22%" />
<col style="width: 62%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Byte 0 Value</p></th>
<th class="head"><p>Byte 1 Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="9"><p>0</p></td>
<td rowspan="9"><p>0</p></td>
<td rowspan="9"><p>Default value after hard reset.</p>
<p>The ‘argument variable’ contents are invalid, BIM</p>
<p>needs to find a valid on-chip user application and</p>
<p>execute it.</p>
<p>If BIM cannot find the valid User Application,</p>
<p>then it will try to find a valid Persistent App</p>
<p>and execute.</p>
<p>If it is unable to find either application it will</p>
<p>put the device to low power sleep mode.</p>
</td>
</tr>
<tr class="row-odd"></tr>
<tr class="row-even"></tr>
<tr class="row-odd"></tr>
<tr class="row-even"></tr>
<tr class="row-odd"></tr>
<tr class="row-even"></tr>
<tr class="row-odd"></tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td rowspan="4"><p>0</p></td>
<td rowspan="4"><p>Flash page number</p></td>
<td rowspan="4"><p>Byte 1 contains the application start address BIM</p>
<p>needs to jump to on resuming execution after a soft</p>
<p>reset. The address will be in terms of flash page</p>
<p>number.</p>
</td>
</tr>
<tr class="row-even"></tr>
<tr class="row-odd"></tr>
<tr class="row-even"></tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Image Type</p></td>
<td><p>Version required to support image format</p></td>
</tr>
<tr class="row-even"><td><p>2-255</p></td>
<td><p>N/A</p></td>
<td><p>Version of Image Header contained in image</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="bim-off-chip.html" class="btn btn-neutral float-left" title="BIM for Off-Chip OAD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="image-header.html" class="btn btn-neutral float-right" title="OAD Image Header" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2010-2024, Texas Instruments.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>